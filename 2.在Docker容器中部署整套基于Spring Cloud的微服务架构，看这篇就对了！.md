## 在Docker容器中部署整套基于Spring Cloud的微服务架构，看这篇就对了！

梦想de星空 [macrozheng](javascript:void(0);) *昨天*

> 本文以`mall-swarm`项目为例，主要介绍一个微服务架构的电商项目如何在Docker容器下部署，涉及到大量系统组件的部署及多个Spring Cloud 微服务应用的部署，基于CentOS7.6。

## 环境搭建

### 基础环境部署

> `mall-swarm`运行需要的系统组件如下，Docker容器中安装这些组件的方法直接参考该文章即可：[mall在Linux环境下的部署（基于Docker容器）](https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&mid=2247483786&idx=1&sn=33052d6967de1a2c9592b2a1c58b8bef&scene=21#wechat_redirect) 。

| 组件          | 版本号 |
| :------------ | :----- |
| JDK           | 1.8    |
| Mysql         | 5.7    |
| Redis         | 3.2    |
| Elasticsearch | 6.4.0  |
| MongoDb       | 3.2    |
| RabbitMq      | 3.7.15 |
| Nginx         | 1.10   |

### 镜像打包上传

> 一共8个应用服务需要打包成Docker镜像，具体如何打包可以参考[使用Maven插件构建Docker镜像](https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&mid=2247483781&idx=1&sn=77379ed72d307cdad67495455d487a97&scene=21#wechat_redirect) 。需要注意的是如果打包过程中遇到找不到`mall-common`、`mall-mbg`或`mall-security`的情况，需要先按顺序将这些模块install到本地maven仓库再进行打包。

| 应用          | 版本号 |
| :------------ | :----- |
| mall-registry | 1.8    |
| mall-config   | 5.7    |
| mall-monitor  | 3.2    |
| mall-gateway  | 6.4.0  |
| mall-admin    | 3.2    |
| mall-portal   | 3.7.15 |
| mall-search   | 1.10   |
| mall-demo     | 1.10   |

镜像打包上传完成后，完整docker仓库镜像示意图：

![img](https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwkY4AayliaP3zgaMCpNiaRjEKUYWiafFVX7EibbSWDD6lpibNpsGO2glpVETagDFXEG5VSHYtKUiarZkdVg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

## 应用部署

### 部署mall-registry

- 通过以下命令运行注册中心`mall-registry`：

```
docker run -p 8001:8001 --name mall-registry \
-v /etc/localtime:/etc/localtime \
-v /mydata/app/mall-registry/logs:/var/logs \
-d mall/mall-registry:1.0-SNAPSHOT
```

- 运行成功后，通过访问该地址可以查看注册中心控制台：http://192.168.6.132:8001/

### 部署mall-config

- 通过以下命令运行配置中心`mall-config`：

```shell
docker run -p 8301:8301 --name mall-config \
--link mall-registry:mall-registry \
-v /etc/localtime:/etc/localtime \
-v /mydata/app/mall-config/logs:/var/logs \
-d mall/mall-config:1.0-SNAPSHOT
```

- 运行成功后，通过访问该地址可以查看`mall-admin`在prod环境下的配置信息：http://192.168.6.132:8301/master/admin-prod.yml
- 需要`注意`的是prod环境下从配置中心获取的是存储在git仓库中的配置，如需更改需要将mall-config模块的配置文件application.yml中的git仓库配置改为你自己的。

```yaml
spring:
  cloud:
    config:
      server:
        git: #Git仓库存储
          uri: https://gitee.com/macrozheng/mall-config.git #改为你自己的配置
          username: macro
          password: 123456
          clone-on-start: true
          search-paths: '{application}'
```

### 部署mall-monitor

- 通过以下命令运行监控中心`mall-monitor`：

```shell
docker run -p 8101:8101 --name mall-monitor \
--link mall-registry:mall-registry \
-v /etc/localtime:/etc/localtime \
-v /mydata/app/mall-monitor/logs:/var/logs \
-d mall/mall-monitor:1.0-SNAPSHOT
```

- 运行完成后可以通过该地址查看监控中心信息，账号密码为`macro:123456`：http://192.168.6.132:8101

### 部署mall-gateway

- 通过以下命令运行网关服务`mall-gateway`：

```shell
docker run -p 8201:8201 --name mall-gateway \
--link mall-registry:mall-registry \
-v /etc/localtime:/etc/localtime \
-v /mydata/app/mall-gateway/logs:/var/logs \
-d mall/mall-gateway:1.0-SNAPSHOT
```

- 运行完成后可以通过该地址查看动态路由规则：http://192.168.6.132:8201/actuator/gateway/routes

### 部署mall-admin

- 通过以下命令运行后台服务`mall-admin`：

```shell
docker run -p 8180:8180 --name mall-admin \
--link mysql:db \
--link mall-registry:mall-registry \
-v /etc/localtime:/etc/localtime \
-v /mydata/app/mall-admin/logs:/var/logs \
-d mall/mall-admin:1.0-SNAPSHOT
```

- 通过`mall-gateway`网关服务访问接口文档：http://192.168.6.132:8201/mall-admin/swagger-ui.html

### 部署mall-portal

- 通过以下命令运行前台服务`mall-portal`：

```shell
docker run -p 8085:8085 --name mall-portal \
--link mysql:db \
--link redis:redis \
--link mongo:mongo \
--link rabbitmq:rabbit \
--link mall-registry:mall-registry \
-v /etc/localtime:/etc/localtime \
-v /mydata/app/mall-portal/logs:/var/logs \
-d mall/mall-portal:1.0-SNAPSHOT
```

- 通过`mall-gateway`网关服务访问接口文档：http://192.168.6.132:8201/mall-portal/swagger-ui.html

### 部署mall-search

- 通过以下命令运行搜索服务`mall-search`：

```shell
docker run -p 8081:8081 --name mall-search \
--link mysql:db \
--link elasticsearch:es \
--link mall-registry:mall-registry \
-v /etc/localtime:/etc/localtime \
-v /mydata/app/mall-search/logs:/var/logs \
-d mall/mall-search:1.0-SNAPSHOT
```

- 通过`mall-gateway`网关服务访问接口文档：http://192.168.6.132:8201/mall-search/swagger-ui.html

### 部署mall-demo

- 通过以下命令运行测试服务`mall-demo`：

```shell
docker run -p 8082:8082 --name mall-demo \
--link mysql:db \
--link mall-registry:mall-registry \
-v /etc/localtime:/etc/localtime \
-v /mydata/app/mall-demo/logs:/var/logs \
-d mall/mall-demo:1.0-SNAPSHOT
```

- 通过`mall-gateway`网关服务访问接口文档：http://192.168.6.132:8201/mall-demo/swagger-ui.html

## 运行完成效果展示

- 注册中心控制台信息：

![img](https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwkY4AayliaP3zgaMCpNiaRjEKmvbicBQXNLyhTuJKHTQqeibiaIje0axbmCvsFugRs53jmgvmghftztqicw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

- 监控中心应用信息：

![img](https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwkY4AayliaP3zgaMCpNiaRjEKTNO7BtcV2sVUyxkPVBxlWsRUEmZm3rlGtxZx0yFnIcXEdTa1SBZIag/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwkY4AayliaP3zgaMCpNiaRjEKHfVOfCxkkh9uFjEqjIzwhx3cEsU2lvaqbxWA3AHW6Zfobbzvyrcg0g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

## 可视化管理工具

> Portainer 是一款轻量级的应用，它提供了图形化界面，用于方便的管理Docker环境，包括单机环境和集群环境，下面我们将用Portainer来管理Docker容器中的应用。

- 官网地址：https://github.com/portainer/portainer
- 获取Docker镜像文件：

```
docker pull portainer/portainer
```

- 使用docker容器运行Portainer：

```shell
docker run -p 9000:9000 -p 8000:8000 --name portainer \
--restart=always \
-v /var/run/docker.sock:/var/run/docker.sock \
-v /mydata/portainer/data:/data \
-d portainer/portainer
```

- 查看Portainer的DashBoard信息：

![img](https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwkY4AayliaP3zgaMCpNiaRjEKMrWicjic7vF0AZ6YfI0bq6hLB3f3wX3OORkicFrmt9j1iaYnrl50CsA1GQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

- 查看所有运行中的容器信息：

![img](https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwkY4AayliaP3zgaMCpNiaRjEKIwR4KRI8RYH60GlKURsL8yAjV2edEXiboKJWRicKAVcicI5z79aExLmeg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

- 查看所有已经下载的Docker镜像：

![img](https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwkY4AayliaP3zgaMCpNiaRjEK67ibUVHpYZsINgtufFStKicaXAIAHhjicyjCa32Gyt4GavCjZEnP375BA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

- 查看`mall-portal`应用的统计信息：

![img](https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwkY4AayliaP3zgaMCpNiaRjEKbepz7nMJsg1mR2UtibysPQAPbm8N9kLHHnFnwf2GF8a7gHvpyBSBAew/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

- 查看`mall-portal`应用的运行过程中打印的日志信息：

![img](https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwkY4AayliaP3zgaMCpNiaRjEKia7WrGPOIsRK622GTETjRTrmTFUGkQ5u0uALXxJP9TactV1P1bWN0EA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

- 进入`mall-portal`应用的容器内部来操作容器内部系统：

![img](https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwkY4AayliaP3zgaMCpNiaRjEKbUsVLs0fy6mklYN8JiciaQEcdgA4ftf3zLic8w1JUplWUeZPem52iaIQuw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

## 项目地址

**https://github.com/macrozheng/mall-swarm**

## 推荐阅读

- [Github标星25K+Star，SpringBoot实战电商项目mall出SpringCloud版本啦！](https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&mid=2247484223&idx=1&sn=9089a6db7274c1c6b8b81710bcab88f3&scene=21#wechat_redirect)
- [如何判断一家互联网公司要倒闭了？](https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&mid=2247484205&idx=1&sn=47cb51e573562e2b760c6285c45fd766&scene=21#wechat_redirect)
- [虚拟机安装及使用Linux，看这一篇就够了！](https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&mid=2247484199&idx=1&sn=2726f3d75875808ae0f7baa45f09d9f0&scene=21#wechat_redirect)
- [涵盖大部分核心组件使用的 Spring Cloud 教程，一定要收藏哦！](https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&mid=2247484188&idx=1&sn=471dc7c44b23c5bd964fda65aefdcea4&scene=21#wechat_redirect)
- [淘宝双11，亿级流量高并发是怎么抗住的？看完这篇你就明白了!](https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&mid=2247484154&idx=1&sn=f765d8abd2294e105f5d10eec0571c4d&scene=21#wechat_redirect)
- [我的Github开源项目，从0到20000 Star！](https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&mid=2247483939&idx=1&sn=bef5753e4885856e6ae7932fb0bdb622&scene=21#wechat_redirect)



------



![img](https://mmbiz.qpic.cn/mmbiz_jpg/CKvMdchsUwmUY7NFNotwPOZvjHa4YxJ2c2hwiblbLibdgNZo8kMiao2ZzWAlOIb5tzHCpmINSrvcSj2cYFcSmgPhw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

**欢迎关注，点个在看**